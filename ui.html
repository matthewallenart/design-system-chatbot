<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AI Design System Assistant</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #ffffff;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      background-color: #f9fafb;
    }
    
    .header-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .header-title h1 {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }
    
    .icon {
      width: 20px;
      height: 20px;
      fill: #2563eb;
    }
    
    .upload-section {
      padding: 16px;
      background-color: #eff6ff;
      border-bottom: 1px solid #bfdbfe;
      text-align: center;
    }
    
    .upload-area {
      padding: 32px 16px;
    }
    
    .upload-icon {
      width: 48px;
      height: 48px;
      fill: #60a5fa;
      margin: 0 auto 16px;
    }
    
    .upload-title {
      font-size: 18px;
      font-weight: 500;
      color: #111827;
      margin-bottom: 8px;
    }
    
    .upload-subtitle {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 16px;
    }
    
    .upload-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background-color: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    
    .upload-btn:hover {
      background-color: #1d4ed8;
    }
    
    .upload-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pdf-status {
      padding: 12px 16px;
      background-color: #dcfce7;
      border-bottom: 1px solid #bbf7d0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #166534;
    }
    
    .change-pdf {
      margin-left: auto;
      color: #059669;
      text-decoration: underline;
      cursor: pointer;
      font-size: 12px;
    }
    
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .welcome-message {
      text-align: center;
      padding: 32px 16px;
      color: #6b7280;
    }
    
    .welcome-icon {
      width: 48px;
      height: 48px;
      fill: #d1d5db;
      margin: 0 auto 16px;
    }
    
    .welcome-title {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 8px;
    }
    
    .suggestions {
      margin-top: 16px;
    }
    
    .suggestions-label {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 8px;
    }
    
    .suggestion-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    
    .suggestion-btn {
      padding: 4px 12px;
      background-color: #f3f4f6;
      color: #6b7280;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .suggestion-btn:hover {
      background-color: #e5e7eb;
    }
    
    .message {
      display: flex;
      margin-bottom: 16px;
    }
    
    .message.user {
      justify-content: flex-end;
    }
    
    .message.ai {
      justify-content: flex-start;
    }
    
    .message.system {
      justify-content: flex-start;
    }
    
    .message-bubble {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    
    .message.user .message-bubble {
      background-color: #2563eb;
      color: white;
    }
    
    .message.ai .message-bubble {
      background-color: #f3f4f6;
      color: #111827;
    }
    
    .message.system .message-bubble {
      background-color: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }
    
    .loading-message {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background-color: #f3f4f6;
      border-radius: 12px;
      font-size: 14px;
      color: #6b7280;
    }
    
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #d1d5db;
      border-top: 2px solid #6b7280;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .input-section {
      padding: 16px;
      border-top: 1px solid #e5e7eb;
      background-color: white;
    }
    
    .input-container {
      display: flex;
      gap: 8px;
    }
    
    .message-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      resize: none;
      outline: none;
    }
    
    .message-input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb;
    }
    
    .send-btn {
      padding: 8px 16px;
      background-color: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .send-btn:hover {
      background-color: #1d4ed8;
    }
    
    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .input-help {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
    }
    
    .hidden {
      display: none !important;
    }
    
    #file-input {
      display: none;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-title">
      <svg class="icon" viewBox="0 0 24 24">
        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
      </svg>
      <h1>Design System Assistant (Free AI)</h1>
    </div>
  </div>

  <div id="upload-section" class="upload-section">
    <div class="upload-area">
      <svg class="upload-icon" viewBox="0 0 24 24">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7,10 12,15 17,10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      <h3 class="upload-title">Upload Design System PDF</h3>
      <p class="upload-subtitle">Upload your design system documentation to start asking questions</p>
      <button id="upload-btn" class="upload-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14,2 14,8 20,8"/>
          <line x1="16" y1="13" x2="8" y2="13"/>
          <line x1="16" y1="17" x2="8" y2="17"/>
          <polyline points="10,9 9,9 8,9"/>
        </svg>
        Choose PDF File
      </button>
      <input type="file" id="file-input" accept=".pdf">
    </div>
  </div>

  <div id="pdf-status" class="pdf-status hidden">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
      <polyline points="14,2 14,8 20,8"/>
    </svg>
    <span id="pdf-name">Document loaded</span>
    <span class="change-pdf" id="change-pdf">Change PDF</span>
  </div>

  <div id="messages-container" class="messages-container">
    <div id="welcome-message" class="welcome-message hidden">
      <svg class="welcome-icon" viewBox="0 0 24 24">
        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
      </svg>
      <h3 class="welcome-title">Ready to help!</h3>
      <p>Ask me anything about your design system documentation</p>
      <div class="suggestions">
        <div class="suggestions-label">Try asking:</div>
        <div class="suggestion-buttons">
          <button class="suggestion-btn" data-suggestion="What are the color guidelines?">What are the color guidelines?</button>
          <button class="suggestion-btn" data-suggestion="How should I use buttons?">How should I use buttons?</button>
          <button class="suggestion-btn" data-suggestion="What's the typography scale?">What's the typography scale?</button>
          <button class="suggestion-btn" data-suggestion="Spacing recommendations?">Spacing recommendations?</button>
        </div>
      </div>
    </div>
  </div>

  <div id="input-section" class="input-section hidden">
    <div class="input-container">
      <textarea 
        id="message-input" 
        class="message-input" 
        placeholder="Ask about your design system..."
        rows="1"
      ></textarea>
      <button id="send-btn" class="send-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <line x1="22" y1="2" x2="11" y2="13"/>
          <polygon points="22,2 15,22 11,13 2,9 22,2"/>
        </svg>
      </button>
    </div>
    <div class="input-help">Press Enter to send • Shift+Enter for new line</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Set up PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    let pdfContent = '';
    let pdfText = '';  // Fixed: Added missing pdfText variable
    let pdfName = '';
    let isLoading = false;
    let messages = [];

    // Get DOM elements
    const uploadSection = document.getElementById('upload-section');
    const pdfStatus = document.getElementById('pdf-status');
    const pdfNameSpan = document.getElementById('pdf-name');
    const messagesContainer = document.getElementById('messages-container');
    const welcomeMessage = document.getElementById('welcome-message');
    const inputSection = document.getElementById('input-section');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const uploadBtn = document.getElementById('upload-btn');
    const fileInput = document.getElementById('file-input');
    const changePdfBtn = document.getElementById('change-pdf');

    console.log('AI Design System Assistant starting...');

    // Initialize event listeners
    function init() {
      console.log('Initializing plugin...');
      
      // Upload button click handler
      if (uploadBtn && fileInput) {
        uploadBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Upload button clicked');
          fileInput.click();
        });
        
        // File input change handler
        fileInput.addEventListener('change', handleFileUpload);
        console.log('Upload handlers set up');
      }
      
      // Send button and input handlers
      if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
      }
      
      if (messageInput) {
        messageInput.addEventListener('keydown', handleKeyPress);
        messageInput.addEventListener('input', autoResizeTextarea);
      }
      
      // Change PDF handler
      if (changePdfBtn) {
        changePdfBtn.addEventListener('click', resetPdf);
      }
      
      // Suggestion button handlers
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('suggestion-btn')) {
          const suggestion = e.target.getAttribute('data-suggestion');
          if (messageInput && suggestion) {
            messageInput.value = suggestion;
            messageInput.focus();
          }
        }
      });
      
      console.log('All event listeners initialized');
    }

    async function handleFileUpload(event) {
      console.log('File upload triggered');
      const file = event.target.files[0];
      
      if (!file) {
        console.log('No file selected');
        return;
      }
      
      if (file.type !== 'application/pdf') {
        alert('Please upload a PDF file');
        return;
      }

      console.log('Processing PDF file:', file.name);
      
      // Update button state
      uploadBtn.innerHTML = '<div class="spinner"></div> Processing...';
      uploadBtn.disabled = true;

      try {
        // Read PDF file as ArrayBuffer for PDF.js
        const arrayBuffer = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(new Error("Failed to read file"));
          reader.readAsArrayBuffer(file);
        });

        console.log('PDF loaded as ArrayBuffer, size:', arrayBuffer.byteLength);

        // Extract text from PDF using PDF.js
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        console.log('PDF loaded successfully, pages:', pdf.numPages);
        
        let extractedText = '';
        
        // Extract text from each page
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          try {
            const page = await pdf.getPage(pageNum);
            const textContent = await page.getTextContent();
            
            const pageText = textContent.items
              .map(item => item.str)
              .join(' ')
              .replace(/\s+/g, ' ')
              .trim();
            
            if (pageText) {
              extractedText += `\n\nPage ${pageNum}:\n${pageText}`;
            }
            
            console.log(`Extracted text from page ${pageNum}, length:`, pageText.length);
          } catch (pageError) {
            console.error(`Error extracting text from page ${pageNum}:`, pageError);
          }
        }

        if (!extractedText.trim()) {
          throw new Error('No text content could be extracted from the PDF. The PDF might be image-based or protected.');
        }

        pdfText = extractedText.trim();
        pdfName = file.name;
        
        console.log('Total extracted text length:', pdfText.length);
        console.log('First 200 characters:', pdfText.substring(0, 200));
        
        // Update UI
        uploadSection.classList.add('hidden');
        pdfStatus.classList.remove('hidden');
        pdfNameSpan.textContent = '📄 ' + file.name + ' loaded';
        welcomeMessage.classList.remove('hidden');
        inputSection.classList.remove('hidden');
        
        addMessage('system', `✅ PDF "${file.name}" uploaded successfully! Extracted ${pdfText.length} characters of text. I can now answer questions about your design system based on the actual document content.`);
        
        console.log('PDF processing completed successfully');
        
      } catch (error) {
        console.error('Error processing PDF:', error);
        let errorMsg = '❌ Error processing PDF: ' + error.message;
        
        if (error.message.includes('No text content')) {
          errorMsg += '\n\nThis PDF might be:\n• Image-based (scanned document)\n• Password protected\n• Corrupted\n\nTry using a text-based PDF with selectable text.';
        }
        
        addMessage('system', errorMsg);
        
        // Reset button
        uploadBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14,2 14,8 20,8"/>
          </svg>
          Choose PDF File
        `;
        uploadBtn.disabled = false;
      }
    }

    function resetPdf() {
      console.log('Resetting PDF');
      
      pdfContent = '';
      pdfText = '';
      pdfName = '';
      messages = [];
      
      uploadSection.classList.remove('hidden');
      pdfStatus.classList.add('hidden');
      welcomeMessage.classList.add('hidden');
      inputSection.classList.add('hidden');
      
      messagesContainer.innerHTML = '';
      messageInput.value = '';
      fileInput.value = '';
      
      uploadBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14,2 14,8 20,8"/>
        </svg>
        Choose PDF File
      `;
      uploadBtn.disabled = false;
    }

    async function sendMessage() {
      const message = messageInput.value.trim();
      
      if (!message) {
        console.log('No message to send');
        return;
      }
      
      if (!pdfText) {
        alert('Please upload a PDF first');
        return;
      }
      
      if (isLoading) {
        console.log('Already loading, ignoring send request');
        return;
      }

      console.log('Sending message:', message);
      
      addMessage('user', message);
      messageInput.value = '';
      autoResizeTextarea();
      
      showLoading();
      isLoading = true;
      sendBtn.disabled = true;

      try {
        console.log('Making API request to Groq...');
        console.log('Question:', message);
        console.log('Full PDF text length:', pdfText.length);
        
        // Prepare text for API (truncate if too long)
        let relevantText = pdfText;
        if (pdfText.length > 15000) {
          console.log('Text too long, finding relevant sections...');
          const questionLower = message.toLowerCase();
          const textLower = pdfText.toLowerCase();
          
          // Try to find relevant sections based on keywords
          const keywords = ['color', 'typography', 'font', 'button', 'spacing', 'margin', 'padding', 'grid', 'component', 'layout', 'style'];
          let bestMatch = '';
          let foundKeyword = '';
          
          for (const keyword of keywords) {
            if (questionLower.includes(keyword)) {
              const index = textLower.indexOf(keyword);
              if (index !== -1) {
                const start = Math.max(0, index - 3000);
                const end = Math.min(pdfText.length, index + 8000);
                bestMatch = pdfText.substring(start, end);
                foundKeyword = keyword;
                console.log(`Found relevant section for keyword "${keyword}"`);
                break;
              }
            }
          }
          
          if (bestMatch) {
            relevantText = bestMatch;
            console.log(`Using relevant section (${relevantText.length} chars) for keyword "${foundKeyword}"`);
          } else {
            // If no specific match, take beginning of document
            relevantText = pdfText.substring(0, 15000);
            console.log('No specific match found, using first 15000 characters');
          }
        }
        
        console.log('Final text length being sent to AI:', relevantText.length);

        const requestBody = {
          model: "llama-3.3-70b-versatile",
          messages: [
            {
              role: "system",
              content: "You are an expert AI assistant specializing in design systems. You help designers understand and implement design system guidelines. Always provide specific, actionable advice based on the provided documentation."
            },
            {
              role: "user",
              content: `Based on the following design system documentation, please answer this question: "${message}"

DESIGN SYSTEM DOCUMENTATION:
${relevantText}

INSTRUCTIONS:
- Answer based ONLY on the provided documentation
- Be specific and cite exact information when possible
- If information isn't in the documentation, clearly state that
- Use clear headings and formatting for readability
- Provide practical, actionable guidance
- If relevant examples or code snippets are in the docs, include them
- Focus on helping the designer implement the guidelines correctly`
            }
          ],
          max_tokens: 1500,
          temperature: 0.1,
          top_p: 0.9
        };

        console.log('Sending request to API...');

        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer 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"
          },
          body: JSON.stringify(requestBody)
        });

        console.log('API response status:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('API Error:', response.status, errorText);
          throw new Error(`API request failed: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        console.log('API response received successfully');
        console.log('Response data:', data);
        
        hideLoading();
        
        if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
          const aiResponse = data.choices[0].message.content;
          console.log('AI response length:', aiResponse.length);
          addMessage('ai', aiResponse);
        } else {
          console.error('Invalid API response format:', data);
          throw new Error('Invalid response format from API');
        }
        
      } catch (error) {
        console.error('Error sending message:', error);
        hideLoading();
        
        let errorMessage = '❌ Sorry, I encountered an error: ';
        
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          errorMessage += 'Network connection failed. Please check your internet connection and ensure the Figma plugin has network access to https://api.groq.com';
        } else if (error.message.includes('429')) {
          errorMessage += 'Rate limit exceeded. Please wait a moment and try again.';
        } else if (error.message.includes('401')) {
          errorMessage += 'API authentication failed. The API key may be invalid or expired.';
        } else if (error.message.includes('403')) {
          errorMessage += 'API access forbidden. Please check your API key permissions.';
        } else {
          errorMessage += error.message;
        }
        
        addMessage('ai', errorMessage);
        
      } finally {
        isLoading = false;
        sendBtn.disabled = false;
        console.log('Message sending completed');
      }
    }

    function addMessage(type, content) {
      messages.push({ type, content });
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      const bubbleDiv = document.createElement('div');
      bubbleDiv.className = 'message-bubble';
      bubbleDiv.textContent = content;
      
      messageDiv.appendChild(bubbleDiv);
      messagesContainer.appendChild(messageDiv);
      
      if (welcomeMessage) {
        welcomeMessage.classList.add('hidden');
      }
      
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function showLoading() {
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'loading-indicator';
      loadingDiv.className = 'message ai';
      loadingDiv.innerHTML = '<div class="loading-message"><div class="spinner"></div><span>Thinking...</span></div>';
      messagesContainer.appendChild(loadingDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function hideLoading() {
      const loadingDiv = document.getElementById('loading-indicator');
      if (loadingDiv) {
        loadingDiv.remove();
      }
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function autoResizeTextarea() {
      if (messageInput) {
        messageInput.style.height = 'auto';
        messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
    
    console.log('Script loaded successfully');
  </script>
</body>
</html>